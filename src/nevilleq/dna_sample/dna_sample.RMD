---
title: "DNA Sample"
author: "Quinton Neville"
date: "6/20/2019"
output:
  html_document: default
  github_document: default
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
#Installation (if needed)
#install rjson
#install.packages("rjson")
#install snakecase (janitor dependency)
#install.packages("snakecase")
#install janitor
#install.packages("janitor") #help tidying
#install.packages("viridis") #colourblind pallete

#Libraries
library(jsonlite)
library(tidyverse)
library(janitor)
library(viridis)
library(purrr)
library(data.table)
library(doParallel)
library(foreach)
library(parallel)
library(maditr)

#Setting root directory
knitr::opts_knit$set(echo = TRUE,
                     root.dir = rprojroot::find_rstudio_root_file())

#Controlling figure output in markdown
knitr::opts_chunk$set(
#  fig.height =   
  fig.width = 6,
#  fig.asp = .5,
  out.width = "90%",
#  out.height = 
  cache = TRUE
)
#Set Theme for ggplot2
theme_set(theme_bw() + theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom"))
#Set Scientific notation output for knitr
options(scipen = 999999)
```




##1. Load DNA Data, Initial Clean

```{r warning = FALSE}
#Unzip and read all three files into a nested tibble
dna.dt <- list.files(path = "./data/original/DNA-Extract/Aggregated-Data") %>%
  as_tibble() %>%
  rename(data_zip_path = value) %>%
  mutate(
    data_zip_path = str_c("./data/original/DNA-Extract/Aggregated-Data/", data_zip_path),
    input_files = map(.x = data_zip_path, ~gzfile(.x) %>% fromJSON())
  ) %>%
  unnest() %>%
  as.data.table() %>%
  dt_select(-c(data_zip_path, section)) #Section does not appear in the code book (DNA Snapshot)


#Missingness
percent.missing <- dna.dt %>%
  is.na.data.frame() %>%
  apply(., 2, mean) %>%
  round(3) #Percentage of missing in each variable
  
#Remove Dateline for 99% missing
dna.dt <- dna.dt %>%
  dt_select(-dateline)

#str(dna.dt)
```

After unzipping, reading, and initially cleaning the data, we obtained the entire DNA data set describing `r nrow(dna.dt)` observations in `r ncol(dna.dt)` variables: `r str_c(names(dna.dt), collapse = ", ")`. The section and dateline variables were removed due to missingness from codebook and `r percent.missing["dateline"] * 100`% missing data, respectively. Further, all variables were initially read in as character vectors.  

##2. Variable Mutation

```{r warning = FALSE, message = FALSE}
dna.dt <- dna.dt %>%
  dt_mutate(
    subject_codes = str_split(subject_codes, ",") %>%
    lapply(., function(x) {x[c(-1, -length(x))]})    #storing subj codes as nested list of char vector
  )
```

##3. Data Profiling by Year  

Here we are investigating (whichever vars)

####Yearly Subsets
```{r}
# Subsetting data for 2013
##Using poorly named generic "df" in order to repeat the code for different years (should be wrapped into function later)
dna.2013 <- dna.dt[ which(dna.dt$publication_date > 1356998400
& dna.dt$publication_date < 1388448000), ]

# Subsetting data for 2014
dna.2014 <- dna.dt[ which(dna.dt$publication_date > 1388534400
& dna.dt$publication_date < 1419984000), ]

# Subsetting data for 2015
dna.2015 <- dna.dt[ which(dna.dt$publication_date > 1420070400
& dna.dt$publication_date < 1451520000 ), ]

# Subsetting data for 2016
dna.2016 <- dna.dt[ which(dna.dt$publication_date > 1451606400
& dna.dt$publication_date < 1483142400 ), ]

#Remove original
remove(dna.dt)
gc()
```

Here 2013-16 elicit `r list(dna.2013, dna.2014, dna.2015, dna.2016) %>% map_dbl(nrow) %>% paste0(., collapse = ", ")` observations, repsectively.

####2013

Body uniqueness
```{r}
#Assign generic df label for code reproduction
df <- dna.2013[sample(1:nrow(dna.2013), 100), ]
#remove(dna.2013)
gc()

#Percentage Unique
df$body %>% unique() %>% length()



```

Here, we observed `r (df$body %>% unique() %>% length()) / nrow(df)`% unique body (text). A bar chart of the most frequently repeated observations can be found below:

```{r}
#Counts top 5
a <- df %>%
  group_by(body) %>%
  summarise(
    Count = n()
  ) %>%
    arrange(desc(Count)) %>%
  mutate(
    body = as.character(body) %>% 
      as.factor() %>%
      forcats::fct_reorder(., Count)
    ) %>% 
  slice(1:5) %>%
    ggplot(aes(x = body, y = Count, fill = Count)) +
  geom_bar(stat = "identity", width = 1, colour = "black") +
  coord_flip() +
  labs(
    x = "Year",
    y = "Number of Domiciles Built",
    title = "Number of Domiciles Built by Year"
  ) +
theme(legend.position = "right",
  axis.text.y = element_text(color = "black", 
  size = 10,  hjust = 1)) +
  scale_fill_viridis_c("Number of Domociles \nBuilt")

```

####2014
```{r}
# Subsetting data for 2014
dna.2014 <- dna.dt[ which(dna.dt$publication_date > 1388534400
& dna.dt$publication_date < 1419984000), ]

```

####2015
```{r}
# Subsetting data for 2015
dna.2015 <- dna.dt[ which(dna.dt$publication_date > 1420070400
& dna.dt$publication_date < 1451520000 ), ]

```

####2016
```{r}
# Subsetting data for 2016
newdates_2016 <- dna.dt[ which(dna.dt$publication_date > 1451606400
& dna.dt$publication_date < 1483142400 ), ]

```


#4. Investigation for Sampling  

